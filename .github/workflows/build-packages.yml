name: Build Linux Packages

on:
  workflow_dispatch:
  push:
    branches: [main]
    tags:
      - "v*"

jobs:
  package:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            libwayland-dev \
            libxkbcommon-dev \
            libcairo2-dev \
            libpango1.0-dev \
            libgtk-3-dev \
            libssl-dev \
            libxcb-shape0-dev \
            libxcb-xfixes0-dev \
            libxcb-render0-dev \
            libxcb1-dev \
            libx11-dev

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install nfpm
        run: |
          NFPM_VERSION=2.43.4
          curl -sSfL "https://github.com/goreleaser/nfpm/releases/download/v${NFPM_VERSION}/nfpm_${NFPM_VERSION}_Linux_x86_64.tar.gz" \
            | tar -xz nfpm
          sudo mv nfpm /usr/local/bin/
          nfpm --version

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            .
            configurator

      - name: Read crate version
        id: meta
        run: |
          VERSION=$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[] | select(.name=="wayscriber") | .version')
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Build & package (tar/deb/rpm)
        env:
          VERSION: ${{ steps.meta.outputs.version }}
          FORMATS: tar,deb,rpm
          ARTIFACT_ROOT: dist
          CARGO_TARGET_DIR: target
        run: |
          ./tools/package.sh

      - name: Upload tarball
        uses: actions/upload-artifact@v4
        with:
          name: wayscriber-${{ steps.meta.outputs.version }}-tar
          path: dist/wayscriber-v${{ steps.meta.outputs.version }}-linux-x86_64.tar.gz

      - name: Upload configurator tarball
        uses: actions/upload-artifact@v4
        with:
          name: wayscriber-configurator-${{ steps.meta.outputs.version }}-tar
          path: dist/wayscriber-configurator-v${{ steps.meta.outputs.version }}-linux-x86_64.tar.gz

      - name: Upload deb
        uses: actions/upload-artifact@v4
        with:
          name: wayscriber-${{ steps.meta.outputs.version }}-deb
          path: dist/wayscriber-amd64.deb

      - name: Upload configurator deb
        uses: actions/upload-artifact@v4
        with:
          name: wayscriber-configurator-${{ steps.meta.outputs.version }}-deb
          path: dist/wayscriber-configurator-amd64.deb

      - name: Upload rpm
        uses: actions/upload-artifact@v4
        with:
          name: wayscriber-${{ steps.meta.outputs.version }}-rpm
          path: dist/wayscriber-x86_64.rpm

      - name: Upload configurator rpm
        uses: actions/upload-artifact@v4
        with:
          name: wayscriber-configurator-${{ steps.meta.outputs.version }}-rpm
          path: dist/wayscriber-configurator-x86_64.rpm

      - name: Upload manifests
        uses: actions/upload-artifact@v4
        with:
          name: wayscriber-${{ steps.meta.outputs.version }}-manifest
          path: |
            dist/checksums.txt
            dist/manifest.json

  release:
    needs: package
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Download packaged artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Publish GitHub release (auto notes)
        uses: softprops/action-gh-release@v2
        with:
          files: dist/**/*
          generate_release_notes: true
